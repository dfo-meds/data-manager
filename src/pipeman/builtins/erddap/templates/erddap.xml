<dataset type="{{dataset['erddap_dataset_type']['short_name']}}" datasetID="{{dataset['erddap_dataset_id']}}" active="true">
{%- macro render_text(text) -%}
    {%- if text is string -%}
        {{text}}
    {%- elif "und" in text and text['und'] -%}
        {{text['und']}}
    {%- elif "en" in text and "fr" in text and text['en'] and text['fr'] -%}
        {{text["en"]}}  |  {{text['fr']}}
    {%- elif "en" in text and text['en'] -%}
        {{text['en']}}
    {%- elif "fr" in text and text['fr'] -%}
        {{text['fr']}}
    {%- endif -%}
{%- endmacro -%}

{%- macro render_text_once(text) -%}
    {%- if text is string -%}
        {{text}}
    {%- elif "und" in text and text['und'] -%}
        {{text['und']}}
    {%- elif "en" in text and text['en'] -%}
        {{text['en']}}
    {%- elif "fr" in text and text['fr'] -%}
        {{text['fr']}}
    {%- endif -%}
{%- endmacro -%}

{%- macro render_bilingual_attr(attr_name_en, attr_name_fr, text) -%}
    {%- if text is string -%}
    <att name="{{attr_name_en}}">{{text}}</att>
    {%- elif "und" in text -%}
    <att name="{{attr_name_en}}">{{text['und']}}</att>
    {%- elif "en" in text and "fr" in text -%}
    <att name="{{attr_name_en}}">{{text["en"]}}  |  {{text['fr']}}</att>
    <att name="{{attr_name_en}}_en">{{text['en']}}</att>
    <att name="{{attr_name_fr}}_fr">{{text['fr']}}</att>
    {%- elif "en" in text -%}
    <att name="{{attr_name_en}}">{{text['en']}}</att>
    {%- elif "fr" in text -%}
    <att name="{{attr_name_en}}">{{text['fr']}}</att>
    {%- endif -%}
{%- endmacro -%}
    <reloadEveryNMinutes>10080</reloadEveryNMinutes>
    <fileDir>{{dataset['erddap_data_file_path']}}</fileDir>
    <fileNameRegex>{{dataset['erddap_data_file_pattern']}}</fileNameRegex>
    <recursive>true</recursive>
    <metadataFrom>last</metadataFrom>
    <iso19115File>/cloud_data/config/{{environment}}/metadata/{{dataset.guid()}}.xml</iso19115File>
    <addAttributes>
        {% if dataset['cdm_data_type'] %}
        <att name="cdm_data_type">{{dataset['cdm_data_type']['short_name']}}</att>
        {% endif %}
        <att name="Conventions">CF-1.6, COARDS, ACDD-1.3</att>
        {% if dataset['point_of_contact'] %}
        {% with author = dataset['metadata_owner'] %}
        {% if author['email'] %}
        <att name="creator_email">{{author['email']}}</att>
        {% endif %}
        {% if author['individual_name'] %}
        <att name="creator_name">{{author['individual_name']}}</att>
        <att name="creator_type">person</att>
        {% elif author['organization_name'] %}
        {{ render_bilingual_attr('creator_name', 'nom_de_createur', author['organization_name']) }}
        <att name="creator_type">organization</att>
        {% endif %}
        {% if author['web_resource'] and author['web_resource'][0] and author['web_resource'][0]['url'] %}
        <att name="creator_url">{{render_text_once(author['web_resource'][0]['url'])}}</att>
        {% endif %}
        {% endwith %}
        {% endif %}
        {% if dataset['creation_date'] %}
        <att name="date_created">{{dataset['creation_date'].strftime('%Y-%m-%d')}}</att>
        {% endif %}
        {% if dataset['publication_date'] %}
        <att name="date_issued">{{dataset['publication_date'].strftime('%Y-%m-%d')}}</att>
        {% endif %}
        {% if dataset['revision_date'] %}
        <att name="date_modified">{{dataset['revision_date'].strftime('%Y-%m-%d')}}</att>
        {% endif %}
        {% if dataset['short_institution'] %}
		<att name="institution">{{dataset['short_institution']}}</att>
        {% endif %}
        {% if dataset['info_link'] and dataset['info_link']['url'] %}
        <att name="infoUrl">{{render_text_once(dataset['info_link']['url'])}}</att>
        {% endif %}
        {% if dataset['licenses'] %}
        <att name="license">
{%- for license in dataset['licenses'] -%}{%- if license['erddap_display'] -%}
{{ license['erddap_display'] }}
{%- endif -%}{%- endfor -%}
        </att>
        {% endif %}
        <att name="sourceUrl">(local files)</att>
        {% if dataset['standard_name_vocab'] %}
        <att name="standard_name_vocabulary">{{dataset['standard_name_vocab']}}</att>
        {% endif %}
        {% if dataset['abstract'] %}
        {{ render_bilingual_attr('summary', 'sommaire', dataset['abstract']) }}
        {% endif %}
        {% if dataset['title'] %}
        {{ render_bilingual_attr('title', 'titre', dataset['title']) }}
        {% endif %}
        {% if dataset['credit'] %}
        {{ render_bilingual_attr('acknowledgement', 'reconnaissance', dataset['credit']) }}
        {% endif %}
        {% if dataset['processing_code'] %}
        <att name="processing_level">{{dataset['processing_code']}}</att>
        {% endif %}
        {% if dataset['project'] %}
        <att name="project">{{dataset['project']}}</att>
        {% endif %}
        {% with pub = dataset['point_of_contact'] %}
        {% if pub %}
        {% if pub['email'] %}
        <att name="publisher_email">{{pub['email']}}</att>
        {% endif %}
        {% if pub['individual_name'] %}
        <att name="publisher_name">{{pub['individual_name']}}</att>
        <att name="publisher_type">person</att>
        {% elif pub['organization_name'] %}
        {{ render_bilingual_attr('publisher', 'nom_de_editeur', pub['organization_name']) }}
        <att name="publisher_type">organization</att>
        {% endif %}
        {% if pub['web_resource'] and pub['web_resource'][0] and pub['web_resource'][0]['url'] %}
        <att name="publisher_url">{{render_text_once(pub['web_resource'][0]['url'])}}</att>
        {% endif %}
        {% endif %}
        {% endwith %}
        {% if dataset['subset_vars'] %}
        <att name="subsetVariables">{{dataset['subset_vars']}}</att>
        {% endif %}
        <att name="keywords">{{basic_keywords}}</att>
        {% if altitude_proxy %}
        <att name="cdm_altitude_proxy">{{altitude_proxy}}</att>
        {% endif %}
        {% if cdm_profile_vars %}
        <att name="cdm_profile_variables">{{cdm_profile_vars}}</att>
        {% endif %}
        {% if cdm_trajectory_vars %}
        <att name="cdm_trajectory_variables">{{cdm_trajectory_vars}}</att>
        {% endif %}
        {% if cdm_timeseries_vars %}
        <att name="cdm_timeseries_variables">{{cdm_timeseries_vars}}</att>
        {% endif %}
        <!-- TODO: history-->

    </addAttributes>
    {% for var in dataset['variables'] %}
    <{% if var['is_axis'] %}axis{% else %}data{% endif %}Variable>
        {% if var['source_name'] %}
        <sourceName>{{var['source_name']}}</sourceName>
        {% endif %}
        {% if var['destination_name'] %}
        <destinationName>{{var['destination_name']}}</destinationName>
        {% endif %}
        {% if var['source_data_type'] %}
        <dataType>{{var['source_data_type']['short_name']}}</dataType>
        {% endif %}
        <addAttributes>
            {% if var['ioos_category'] %}
            <att name="ioos_category">{{var['ioos_category']['short_name']}}</att>
            {% endif %}
            {% if var['long_name'] %}
            {{ render_bilingual_attr('long_name', 'nom_long', var['long_name']) }}
            {% endif %}
            {% if var['standard_name'] %}
            <att name="standard_name">{{var['standard_name']}}</att>
            {% endif %}
            {% if var['units'] %}
            <att name="units">{{var['units']}}</att>
            {% endif %}
            {% if var['source_data_type']['short_name'] == 'String' and var['encoding'] %}
            <att name="_Encoding">{{var['encoding']['short_name']}}</att>
            {% endif %}
            {% if var['fill_value'] %}
            <att name="missing_value" type="{{var['destination_data_type']['short_name']}}">{{var['fill_value']}}</att>
            {% endif %}
            {% if var['scale_factor'] %}
            <att name="scale_factor" type="{{var['destination_data_type']['short_name']}}">{{var['scale_factor']}}</att>
            {% endif %}
            {% if var['add_offset'] %}
            <att name="add_offset" type="{{var['destination_data_type']['short_name']}}">{{var['add_offset']}}</att>
            {% endif %}
            {% if var['time_precision'] %}
                {% if var['time_precision']['short_name'] == 'month' %}
                    <att name="time_precision">1970-01</att>
                {% elif var['time_precision']['short_name'] == 'day' %}
                    <att name="time_precision">1970-01-01</att>
                {% elif var['time_precision']['short_name'] == 'hour' %}
                    <att name="time_precision">1970-01-01T00Z</att>
                {% elif var['time_precision']['short_name'] == 'minute' %}
                    <att name="time_precision">1970-01-01T00:00Z</att>
                {% elif var['time_precision']['short_name'] == 'second' %}
                    <att name="time_precision">1970-01-01T00:00:00Z</att>
                {% elif var['time_precision']['short_name'] == 'tenth_second' %}
                    <att name="time_precision">1970-01-01T00:00.0Z</att>
                {% elif var['time_precision']['short_name'] == 'hundredth_second' %}
                    <att name="time_precision">1970-01-01T00:00.00Z</att>
                {% elif var['time_precision']['short_name'] == 'millisecond' %}
                    <att name="time_precision">1970-01-01T00:00.000Z</att>
                {% endif %}
            {% endif %}
            {% if var['time_zone'] %}
            <att name="time_zone">{{var['time_zone']['short_name']}}</att>
            {% endif %}
            {% if var['min_value'] %}
            <att name="actual_min">{{var['min_value']}}</att>
            {% endif %}
            {% if var['max_value'] %}
            <att name="actual_max">{{var['max_value']}}</att>
            {% endif %}
            {% if var['valid_min'] %}
            <att name="valid_min">{{var['valid_min']}}</att>
            {% endif %}
            {% if var['valid_max'] %}
            <att name="valid_max">{{var['valid_max']}}</att>
            {% endif %}
            {% if var['role'] and var['role']['short_name'] in ('profile_id', 'timeseries_id', 'trajectory_id') %}
            <att name="cf_role">{{var['role']['short_name']}}</att>
            {% endif %}
        </addAttributes>
    </{% if var['is_axis'] %}axis{% else %}data{% endif %}Variable>
    {% endfor %}
</dataset>